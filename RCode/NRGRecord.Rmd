---
title: "Modeling Activity of Neurons from NRG recording study"
output: 
  html_document:
    keep_md: true
---
##Introduction
##Methods
We are attempting to find a function of the recorded eye and head movements that will predict the firing rate of the neuron during the trial. We convert the recorded spike times into a continuous function by convolving them with a Gaussian with a 15ms standard deviation to create a spike density function. We scale the spike density function so that it approximates the firing rate in spikes per second. For this analysis, we separate leftward and rightward movements to produce 12 possible predictor variables: (right/left)(eye/head)(position/velocity/acceleration), represented by the abreviations: *rhp, lhp, rep, lep, rhv, lhv, rev, lev, rha, lha, rea* and *lea*. 

We use Matlabâ€™s **stepwiselm** function, beginning with a constant model. The function evaluates the set of available terms, which includes the predictor variables described above, as well as pairwise interactions. If any of these terms improve the R2 of the model by 0.05 or more, the threshold criterion we chose, it includes the best term and then repeates the evaluation to see if any other terms could improve the model further. If these neurons were involved in generating the observed eye and head behavior, we assume that there would be a time delay between neural activity and movement. We repeated this stepwise model fitting to shifted data, in 10ms increments up to 200ms. We employed stepwise fitting method to find the best fit at each location independently. We then chose the delay that gave the best fit, determined by the $R^2$ weighted by the number of terms in the model. Each additional term must improve the fit by at least 0.05. For example, if the best fit at a 50ms delay was a model with two terms an $R^2$ of 0.29, and the best fit at 60ms was a model with three terms and an $R^2$ of 0.30, we chose the simpler model.

##Results

```{r load csv, cache=FALSE,message=FALSE,warning=FALSE}
library(ggplot2)
library(dplyr)
filename<-"~/MATLAB/NRGRecording/bestFitLR.csv"
d <- read.csv(filename, na.strings="NaN")
```


```{r shift_histogram}
qplot(d$shift,binwidth=20,xlab='Shift (ms)')+geom_vline(xintercept=mean(d$shift),size=2)

```

The average shift was `r round(mean(d$shift),2)`ms, with a standard deviation of `r round(sd(d$shift),2)`. 

```{r rsquared_histogram}
qplot(d$rsquared,binwidth=0.1,xlab='R-squared')+geom_vline(xintercept=mean(d$rsquared),size=2)

```


The average $R^2$ was `r round(mean(d$rsquared),2)`, with a standard deviation of `r round(sd(d$rsquared),2)`.

```{r fitvars, echo=FALSE}
d$rhvC<-grepl('rhv',d$f)
d$lhvC<-grepl('lhv',d$f)
d$repC<-grepl('rep',d$f)
d$lepC<-grepl('lep',d$f)
d$rhpC<-grepl('rhp',d$f)
d$lhpC<-grepl('lhp',d$f)
d$rhaC<-grepl('rha',d$f)
d$lhaC<-grepl('lha',d$f)
d$revC<-grepl('rev',d$f)
d$levC<-grepl('lev',d$f)
d$reaC<-grepl('rea',d$f)
d$leaC<-grepl('lea',d$f)


```

Regarding the final best-fit formulas from our `r length(d$f)` neurons, `r sum(d$rhvC)` models included rightward head velocity, `r sum(d$lhvC)` included leftward head velocity and `r sum(d$rhvC&d$lhvC)` included head velocity in both directions. Similarly, `r sum(d$repC)` models included rightward eye position, `r sum(d$lepC)` included leftward eye position and `r sum(d$repC&d$lepC)` included eye position in both directions. 

Of the `r sum(d$repC|d$lepC)` models that included an eye position component, `r sum((d$repC|d$lepC) & (d$rhvC|d$lhvC))` also indluded a head velocity component and `r sum((d$repC|d$lepC) & !(d$rhvC|d$lhvC))` did not. 

```{r modelcount,message=FALSE,warning=FALSE}

d$f<-as.character(d$f)
d$f<-substr(d$f,start=9,stop=nchar(d$f))
d$f<-as.factor(d$f)
q<- d %>%
  group_by(f) %>%
  summarize(Count=n())

q$f<-reorder(q$f,desc(q$Count))
p <- ggplot(q, aes(y=Count)) + theme(axis.text.x=element_text(size=18,angle=45, hjust=1))
p+geom_bar(aes(x=f),data=q,stat='identity')+ylab('Count')+xlab('Model Fit')


```